From 58b0231490b45e7bf4fa95c9d46cd50db5d3cfee Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Sat, 22 Oct 2022 01:21:56 -0500
Subject: [PATCH 2/3] add UPB_DLL mechanism for missing symbols on windows

Co-Authored-By: "H. Vetinari" <h.vetinari@gmx.com>
---
 CMakeLists.txt                   | 4 ++++
 third_party/upb/upb/port_def.inc | 8 ++++++++
 third_party/upb/upb/upb.c        | 2 +-
 third_party/upb/upb/upb.h        | 2 +-
 4 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 657421e..6cf7b48 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -4218,6 +4218,10 @@ if(WIN32 AND MSVC)
   set_target_properties(upb PROPERTIES COMPILE_PDB_NAME "upb"
     COMPILE_PDB_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}"
   )
+  set_target_properties(upb PROPERTIES DEFINE_SYMBOL "UPB_DLL_EXPORTS")
+  if(BUILD_SHARED_LIBS)
+    target_compile_definitions(upb INTERFACE UPB_DLL_IMPORTS)
+  endif()
   if(gRPC_INSTALL)
     install(FILES ${CMAKE_CURRENT_BINARY_DIR}/upb.pdb
       DESTINATION ${gRPC_INSTALL_LIBDIR} OPTIONAL
diff --git a/third_party/upb/upb/port_def.inc b/third_party/upb/upb/port_def.inc
index 2b240ff..5898b46 100644
--- a/third_party/upb/upb/port_def.inc
+++ b/third_party/upb/upb/port_def.inc
@@ -259,3 +259,11 @@ void __asan_unpoison_memory_region(void const volatile *addr, size_t size);
 #else
 #define UPB_TREAT_PROTO2_ENUMS_LIKE_PROTO3 0
 #endif
+
+#if defined(UPB_DLL_EXPORTS)
+#define UPB_DLL __declspec(dllexport)
+#elif defined(UPB_DLL_IMPORTS)
+#define UPB_DLL __declspec(dllimport)
+#else
+#define UPB_DLL
+#endif // defined(UPB_DLL_EXPORTS)
diff --git a/third_party/upb/upb/upb.c b/third_party/upb/upb/upb.c
index 55730bb..579635b 100644
--- a/third_party/upb/upb/upb.c
+++ b/third_party/upb/upb/upb.c
@@ -112,7 +112,7 @@ static uintptr_t upb_cleanup_metadata(uint32_t* cleanup,
   return (uintptr_t)cleanup | has_initial_block;
 }
 
-upb_alloc upb_alloc_global = {&upb_global_allocfunc};
+UPB_DLL upb_alloc upb_alloc_global = {&upb_global_allocfunc};
 
 /* upb_Arena ******************************************************************/
 
diff --git a/third_party/upb/upb/upb.h b/third_party/upb/upb/upb.h
index e074911..29e8a7b 100644
--- a/third_party/upb/upb/upb.h
+++ b/third_party/upb/upb/upb.h
@@ -135,7 +135,7 @@ UPB_INLINE void upb_free(upb_alloc* alloc, void* ptr) {
 
 /* The global allocator used by upb.  Uses the standard malloc()/free(). */
 
-extern upb_alloc upb_alloc_global;
+UPB_DLL extern upb_alloc upb_alloc_global;
 
 /* Functions that hard-code the global malloc.
  *
-- 
2.37.3

