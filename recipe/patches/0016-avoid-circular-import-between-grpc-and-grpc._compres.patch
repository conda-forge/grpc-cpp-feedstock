From e8b805728a7151c4e59a4512eaafd800a5cca3d1 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Sat, 21 Feb 2026 12:37:11 +1100
Subject: [PATCH 16/17] avoid circular import between grpc and
 grpc._compression

---
 src/python/grpcio/grpc/__init__.py     | 17 +------------
 src/python/grpcio/grpc/_compression.py | 35 ++++++++++++++++++--------
 2 files changed, 25 insertions(+), 27 deletions(-)

diff --git a/src/python/grpcio/grpc/__init__.py b/src/python/grpcio/grpc/__init__.py
index d728bb886c..3eb0b85f61 100644
--- a/src/python/grpcio/grpc/__init__.py
+++ b/src/python/grpcio/grpc/__init__.py
@@ -19,8 +19,8 @@ import enum
 import logging
 import sys
 
-from grpc import _compression
 from grpc._cython import cygrpc as _cygrpc
+from grpc._compression import Compression
 from grpc._runtime_protos import protos
 from grpc._runtime_protos import protos_and_services
 from grpc._runtime_protos import services
@@ -2234,21 +2234,6 @@ def _create_servicer_context(rpc_event, state, request_deserializer):
     context._finalize_state()  # pylint: disable=protected-access
 
 
-@enum.unique
-class Compression(enum.IntEnum):
-    """Indicates the compression method to be used for an RPC.
-
-    Attributes:
-     NoCompression: Do not use compression algorithm.
-     Deflate: Use "Deflate" compression algorithm.
-     Gzip: Use "Gzip" compression algorithm.
-    """
-
-    NoCompression = _compression.NoCompression
-    Deflate = _compression.Deflate
-    Gzip = _compression.Gzip
-
-
 ###################################  __all__  #################################
 
 __all__ = (
diff --git a/src/python/grpcio/grpc/_compression.py b/src/python/grpcio/grpc/_compression.py
index 0994ae3e51..7d226f3c33 100644
--- a/src/python/grpcio/grpc/_compression.py
+++ b/src/python/grpcio/grpc/_compression.py
@@ -14,37 +14,49 @@
 
 from __future__ import annotations
 
+import enum
 from typing import Optional
 
-import grpc
 from grpc._cython import cygrpc
 from grpc._typing import MetadataType
 
-NoCompression = cygrpc.CompressionAlgorithm.none
-Deflate = cygrpc.CompressionAlgorithm.deflate
-Gzip = cygrpc.CompressionAlgorithm.gzip
+
+@enum.unique
+class Compression(enum.IntEnum):
+    """Indicates the compression method to be used for an RPC.
+
+    Attributes:
+     NoCompression: Do not use compression algorithm.
+     Deflate: Use "Deflate" compression algorithm.
+     Gzip: Use "Gzip" compression algorithm.
+    """
+
+    NoCompression = cygrpc.CompressionAlgorithm.none
+    Deflate = cygrpc.CompressionAlgorithm.deflate
+    Gzip = cygrpc.CompressionAlgorithm.gzip
+
 
 _METADATA_STRING_MAPPING = {
-    NoCompression: "identity",
-    Deflate: "deflate",
-    Gzip: "gzip",
+    Compression.NoCompression: "identity",
+    Compression.Deflate: "deflate",
+    Compression.Gzip: "gzip",
 }
 
 
 def _compression_algorithm_to_metadata_value(
-    compression: grpc.Compression,
+    compression: Compression,
 ) -> str:
     return _METADATA_STRING_MAPPING[compression]
 
 
-def compression_algorithm_to_metadata(compression: grpc.Compression):
+def compression_algorithm_to_metadata(compression: Compression):
     return (
         cygrpc.GRPC_COMPRESSION_REQUEST_ALGORITHM_MD_KEY,
         _compression_algorithm_to_metadata_value(compression),
     )
 
 
-def create_channel_option(compression: Optional[grpc.Compression]):
+def create_channel_option(compression: Optional[Compression]):
     return (
         ((cygrpc.GRPC_COMPRESSION_CHANNEL_DEFAULT_ALGORITHM, int(compression)),)
         if compression
@@ -53,7 +65,7 @@ def create_channel_option(compression: Optional[grpc.Compression]):
 
 
 def augment_metadata(
-    metadata: Optional[MetadataType], compression: Optional[grpc.Compression]
+    metadata: Optional[MetadataType], compression: Optional[Compression]
 ):
     if not metadata and not compression:
         return None
@@ -65,6 +77,7 @@ def augment_metadata(
 
 
 __all__ = (
+    # Compression lives in grpc namespace directly
     "Deflate",
     "Gzip",
     "NoCompression",
