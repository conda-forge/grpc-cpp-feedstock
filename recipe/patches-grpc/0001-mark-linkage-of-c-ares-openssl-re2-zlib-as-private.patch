From 934e9bdf34e00817d8c136d61448fe4b1db916a3 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Tue, 23 Aug 2022 11:45:20 +0200
Subject: [PATCH 1/5] mark linkage of c-ares/openssl/re2/zlib as private

Co-Authored-By: Mark Harfouche <mark.harfouche@gmail.com>
---
 CMakeLists.txt | 80 +++++++++++++++++++++++++++-----------------------
 1 file changed, 44 insertions(+), 36 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2bfbcd4c6b..1c22d338f1 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -2137,26 +2137,30 @@ target_include_directories(grpc
     ${_gRPC_ZLIB_INCLUDE_DIR}
 )
 target_link_libraries(grpc
-  ${_gRPC_BASELIB_LIBRARIES}
-  ${_gRPC_ZLIB_LIBRARIES}
-  ${_gRPC_CARES_LIBRARIES}
-  ${_gRPC_ADDRESS_SORTING_LIBRARIES}
-  ${_gRPC_RE2_LIBRARIES}
-  ${_gRPC_UPB_LIBRARIES}
-  ${_gRPC_ALLTARGETS_LIBRARIES}
-  absl::flat_hash_map
-  absl::inlined_vector
-  absl::bind_front
-  absl::hash
-  absl::statusor
-  absl::variant
-  absl::utility
-  gpr
-  ${_gRPC_SSL_LIBRARIES}
-  address_sorting
+  # core libs
+  PUBLIC  ${_gRPC_ALLTARGETS_LIBRARIES}
+  PUBLIC  ${_gRPC_BASELIB_LIBRARIES}
+  # vendored libs
+  PUBLIC  ${_gRPC_ADDRESS_SORTING_LIBRARIES}
+  PUBLIC  ${_gRPC_UPB_LIBRARIES}
+  # external dependencies used within grpc
+  PRIVATE ${_gRPC_CARES_LIBRARIES}
+  PRIVATE ${_gRPC_RE2_LIBRARIES}
+  PRIVATE ${_gRPC_SSL_LIBRARIES}
+  PRIVATE ${_gRPC_ZLIB_LIBRARIES}
+  # external dependencies that need to available at runtime
+  PUBLIC  absl::flat_hash_map
+  PUBLIC  absl::inlined_vector
+  PUBLIC  absl::bind_front
+  PUBLIC  absl::hash
+  PUBLIC  absl::statusor
+  PUBLIC  absl::variant
+  PUBLIC  absl::utility
+  # targets which belong to grpc anyway
+  PUBLIC  gpr
 )
 if(_gRPC_PLATFORM_IOS OR _gRPC_PLATFORM_MAC)
-  target_link_libraries(grpc "-framework CoreFoundation")
+  target_link_libraries(grpc PUBLIC "-framework CoreFoundation")
 endif()
 
 foreach(_hdr
@@ -2719,25 +2723,29 @@ target_include_directories(grpc_unsecure
     ${_gRPC_ZLIB_INCLUDE_DIR}
 )
 target_link_libraries(grpc_unsecure
-  ${_gRPC_BASELIB_LIBRARIES}
-  ${_gRPC_ZLIB_LIBRARIES}
-  ${_gRPC_CARES_LIBRARIES}
-  ${_gRPC_ADDRESS_SORTING_LIBRARIES}
-  ${_gRPC_RE2_LIBRARIES}
-  ${_gRPC_UPB_LIBRARIES}
-  ${_gRPC_ALLTARGETS_LIBRARIES}
-  absl::flat_hash_map
-  absl::inlined_vector
-  absl::bind_front
-  absl::hash
-  absl::statusor
-  absl::variant
-  absl::utility
-  gpr
-  address_sorting
+  # core libs
+  PUBLIC  ${_gRPC_ALLTARGETS_LIBRARIES}
+  PUBLIC  ${_gRPC_BASELIB_LIBRARIES}
+  # vendored libs
+  PUBLIC  ${_gRPC_ADDRESS_SORTING_LIBRARIES}
+  PUBLIC  ${_gRPC_UPB_LIBRARIES}
+  # external dependencies used within grpc
+  PRIVATE ${_gRPC_CARES_LIBRARIES}
+  PRIVATE ${_gRPC_RE2_LIBRARIES}
+  PRIVATE ${_gRPC_ZLIB_LIBRARIES}
+  # external dependencies that need to available at runtime
+  PUBLIC  absl::flat_hash_map
+  PUBLIC  absl::inlined_vector
+  PUBLIC  absl::bind_front
+  PUBLIC  absl::hash
+  PUBLIC  absl::statusor
+  PUBLIC  absl::variant
+  PUBLIC  absl::utility
+  # targets which belong to grpc anyway
+  PUBLIC  gpr
 )
 if(_gRPC_PLATFORM_IOS OR _gRPC_PLATFORM_MAC)
-  target_link_libraries(grpc_unsecure "-framework CoreFoundation")
+  target_link_libraries(grpc_unsecure PUBLIC "-framework CoreFoundation")
 endif()
 
 foreach(_hdr
@@ -17471,7 +17479,7 @@ generate_pkgconfig(
   "high performance general RPC framework"
   "${gRPC_CORE_VERSION}"
   "gpr openssl absl_base absl_bind_front absl_cord absl_core_headers absl_flat_hash_map absl_hash absl_inlined_vector absl_memory absl_optional absl_random_random absl_status absl_statusor absl_str_format absl_strings absl_synchronization absl_time absl_utility absl_variant"
-  "-lgrpc -laddress_sorting -lre2 -lupb -lcares -lz"
+  "-lgrpc -laddress_sorting -lupb"
   ""
   "grpc.pc")
 
-- 
2.37.0.windows.1

